# Stage 1: Build the project JAR inside Docker using Maven (Java 8)
# Sử dụng image Maven với OpenJDK 8 làm môi trường build. Đã chuyển sang tag chung hơn (maven:3-jdk-8) để tránh lỗi 'not found'.
FROM maven:3-jdk-8 AS builder
WORKDIR /workspace

# -------------------------------------------------------------------------
# TỐI ƯU CACHE MAVEN:
# 1) Chỉ COPY các file pom.xml trước để Docker có thể cache layer dependencies.
# 2) Chạy dependency:go-offline để tải dependencies theo POM (cache sẽ reuse nếu POM không đổi).
# 3) Sau đó mới COPY toàn bộ source và build.
# -------------------------------------------------------------------------

# Copy POM root và POM của hệ thống (multi-module)
COPY pom.xml pom.xml
COPY system/pom.xml system/pom.xml
COPY system/net.techres.restaurant_dashboard.api/pom.xml system/net.techres.restaurant_dashboard.api/pom.xml

# Prime Maven cache (không chạy tests, chỉ tải dependencies)
RUN mvn -f system/pom.xml -B -Dmaven.javadoc.skip=true -DskipTests -pl net.techres.restaurant_dashboard.api -am dependency:go-offline

# Sao chép toàn bộ dự án đa module sau khi cache đã sẵn sàng
COPY . .

# Xác nhận cấu trúc và build module mục tiêu
WORKDIR /workspace/system
RUN echo "=== Debug: WORKDIR hiện tại ===" && pwd && ls -alh

# Build module chính (skip tests) – lớp này sẽ tận dụng cache Maven từ bước trên
RUN mvn clean install -T 2 -pl net.techres.restaurant_dashboard.api -am -DskipTests -Dmaven.javadoc.skip=true


# Stage 2: Runtime image carrying the built JAR
# Sử dụng OpenJDK 8 JRE bản slim (rất nhỏ gọn) để chạy ứng dụng
FROM openjdk:8-jre-slim
WORKDIR /

# -------------------------------------------------------------------------
# Bước 1: Copy file JAR đã build từ Stage 1
# -------------------------------------------------------------------------
# Copy file JAR của module net.techres.restaurant_dashboard.api đã build
# Quan trọng: Đường dẫn copy giờ đây phải là: /workspace/system/ten_module/...
COPY --from=builder /workspace/system/net.techres.restaurant_dashboard.api/target/net.techres.restaurant_dashboard.api.jar /service.jar
COPY --from=builder /workspace/techres.config.properties /techres.config.properties
COPY --from=builder /workspace/build.sh /build.sh


RUN chmod +x /service.jar
RUN chmod +x /build.sh
# Thiết lập quyền cho file cấu hình nếu cần
RUN chmod +x /techres.config.properties
# Lưu ý: Không cần thiết lập chmod +x cho file cấu hình (.properties, .json)
# vì chúng không phải là file thực thi.

# Lệnh chạy mặc định khi container khởi động
ENTRYPOINT ["/build.sh"]
